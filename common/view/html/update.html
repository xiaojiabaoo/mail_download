<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <link rel="icon" href="http://127.0.0.1:8023/static/image/img.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>CLL</title>
    <link rel="stylesheet" href="/static/js/layui-v2.6.8/css/layui.css">
    <link rel="stylesheet" href="/static/css/config.css">
    <style>
        .child {
            display: inline-block;
            /*子元素文字会继承居中，因此要在上面写上向左边居中*/
            text-align: left;
            background-color: #FAFAFA;
            width: 1000px;
            height: 180px;
            border-radius: 5px;
        }

        .parent {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .tips-night {
            color: #EAECEE;
            -webkit-background-clip: text;
            font-weight: bold;
        }

        .tips-day {
            color: #1B2631;
            -webkit-background-clip: text;
            font-weight: bold;
        }

        .layui-btn-fluid {
            border-color: #FFB6C1 !important;
            background-color: #FFB6C1;
            color: #fff9ec !important;
            font-weight: bolder;
        }
        .layui-layer-setwin .layui-layer-close2 {
            position: absolute;
            right: -4px !important;
            top: -7px !important;
            width: 30px;
            height: 30px;
            margin-left: 0;
            background-position: -149px -31px;
            *right: -18px;
            _display: none;
        }
        .layui-btn-xs {
            border-color: #FFB6C1 !important;
            color: #FFB6C1 !important;
        }
        .layui-layer-btn .layui-layer-btn0 {
            border-color: #FFB6C1 !important;
            background-color: #FFB6C1 !important;
            color: #fff;
        }
        .layui-layer-title {
            padding: 0 80px 0 20px;
            height: 50px;
            line-height: 50px;
            border-bottom: 1px solid #FFB6C1 !important;
            font-size: 14px;
            color: #333;
            overflow: hidden;
            border-radius: 2px 2px 0 0;
        }
    </style>
</head>
<body>
<form class="layui-form" action="">
    <div class="parent">
        <div class="child">
            <div id="load_update_div" style="margin-left: 70px;margin-top: 40px;font-size: 17px;font-weight: bold;">
                检查更新中，请稍后......
            </div>
            <div id="has_update_div" class="layui-form-item" style="margin-top: 20px;margin-left: 20px;display: none;">
                <div  style="margin-left: 50px;margin-top: 40px;font-size: 17px;font-weight: bold;">
                    <span>当前版本：</span>
                    <span id="danqian_banben"></span>
                </div>
                <div style="margin-left: 50px;margin-top: 10px;">
                    <span>
                        <button type="button" id="check_update_button" class="layui-btn layui-btn-primary layui-btn-xs">检查更新</button>
                    </span>
                </div>
                <div id="content" style="margin-left: 50px;margin-top: 20px;"></div>
            </div>
            <div class="layui-form-item" id="update_button" style="display: none;">
                <div class="layui-input-block" style="margin-left: 70px;width: 300px;">
                    <button type="button" class="layui-btn layui-border layui-btn-fluid">
                        下载更新
                        <i class="layui-icon layui-icon-upload-drag" layui-btn-disabled></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
<script src="/static/js/layui-v2.6.8/layui.js"></script>
<script type="text/javascript" src="/static/js/jquery-2.1.3.js"></script>
<script src="/static/js/config.js" charset="utf-8"></script>
<script>
    layui.use(['layer', 'laydate'], function () {
        let form = layui.form;
        let layer = layui.layer;
        let date = new Date();
        if (date.getHours() >= 18 || date.getHours() <= 6) {
            $("body").css("background-color", "#111")
            $(".child").css("background-color", "#222").css("color", "#f2f2f2")
            $("input").css("background-color", "#333")
            $("input").css("border", "none")
            $("input").css("color", "#f2f2f2")
            $("#tips").removeClass("tips-day")
            $("#tips").addClass("tips-night")
            form.render();
        } else {
            $("#tips").removeClass("tips-night")
            $("#tips").addClass("tips-day")
        }

        window.hasUpdateHtml = function (version, describe) {
            let str = ''
            str += '<span>最新版本：Version '+version+'   <span class="layui-badge">新</span></span>'
            str += '<div style="margin-top: 10px;line-height: 25px;width: 870px;">更新描述：'+ describe+'</div>'
            $("#content").html(str)
            $(".child").height((180+90)+"px")
            $("#update_button").show()
            $("#load_update_div").hide()
            $("#has_update_div").show()
            form.render();
        }

        window.noUpdateHtml = function () {
            let str = ''
            str += '<span>已是最新版本，无需更新</span>'
            $("#content").html(str)
            $(".child").height("180px")
            $("#update_button").hide()
            $("#load_update_div").hide()
            $("#has_update_div").show()
            form.render();
        }

        window.updated_status = function () {
            localStorage.setItem("ccl_danqian_banben", localStorage.getItem("ccl_xin_banben"))
            localStorage.removeItem("ccl_xin")
            localStorage.removeItem("ccl_xin_banben")
            localStorage.removeItem("ccl_xin_miaoshu")
            window.parent.UpdateTab()
            noUpdateHtml()
            $("#danqian_banben").text("Version "+localStorage.getItem("ccl_danqian_banben"))
        }

        window.an_update = function (result) {
            localStorage.setItem("ccl_xin", "true");
            localStorage.setItem("ccl_xin_banben", result.new_version);
            localStorage.setItem("ccl_danqian_banben", result.current_version);
            localStorage.setItem("ccl_xin_miaoshu", result.describe);
            hasUpdateHtml(result.new_version, result.describe)
            $("#danqian_banben").text("Version "+result.current_version)
            window.parent.UpdateTab()
        }

        window.no_update = function (version) {
            $("#danqian_banben").text("Version "+version)
            localStorage.setItem("ccl_danqian_banben", version);
            localStorage.removeItem("ccl_xin")
            localStorage.removeItem("ccl_xin_banben")
            localStorage.removeItem("ccl_xin_miaoshu")
            noUpdateHtml()
            window.parent.UpdateTab()
        }

        window.getUpdateData = function (source) {
            if (source == "click") {
                show_loading("检测版本更新中......")
            }
            $.ajax({
                url: "/system/check_update",
                method: "POST",
                dataType: "json",
                success: function (data) {
                    // 请求成功时的处理
                    if (data.ret > 0) {
                        layer.msg(data.msg, {icon: 5, anim: 6});
                        return false
                    }
                    let result = data.data
                    if (result.new_version == 0) {
                        layer.msg("检查更新出现错误", {icon: 2, anim: 6})
                        return false
                    }
                    if (result.current_version == result.new_version) {
                        if (source == "click") {
                            layer.msg("当前已是最新版本，无需更新", {icon: 7, anim: 6})
                        }
                        let date = new Date()
                        localStorage.setItem("ccl_select_no_update", date.getTime()/1000);
                        no_update(result.current_version)
                        return false
                    } else {
                        if (source == "click") {
                            layer.msg("检测到新版本：Version "+result.new_version, {icon: 1, anim: 1})
                        }
                        an_update(result)
                    }
                    if (source == "init") {
                        $("#ccl_danqian_banben").text("Version "+result.current_version)
                    }
                },
                error: function (error) {
                    // 请求失败时的处理
                    layer.msg("服务器异常", {icon: 5, anim: 6});
                },
                complete: function() {
                    // 请求完成后隐藏加载中动画
                    if (source == "click") {
                        hide_loading()
                    }
                }
            });
        };

        window.init = function () {
            let danqian_banben = localStorage.getItem("ccl_danqian_banben");
            let xin = localStorage.getItem("ccl_xin");
            if (checkNull(danqian_banben) == "" || checkNull(xin) == "") {
                let date = new Date()
                let item = localStorage.getItem("ccl_select_no_update");
                item = checkNull(item) == "" ? 0:item;
                if ((date.getTime() / 1000) - item > (60*5)) {
                    getUpdateData("init")
                } else {
                    no_update(danqian_banben)
                }
            } else {
                $("#danqian_banben").text("Version "+danqian_banben)
                if (xin == "true") {
                    hasUpdateHtml(localStorage.getItem("ccl_xin_banben"), localStorage.getItem("ccl_xin_miaoshu"))
                } else {
                    noUpdateHtml()
                }
                form.render();
            }
        }
        init()

        $("#check_update_button").click(function() {
            getUpdateData("click")
        });

        $(".layui-btn-fluid").click(function() {
            let str = ''
            str += '<div>1.更新过程视网络情况可能需要较长的时间，正常情况下不会超过5分钟，更新过程中请不要退出程序和网页（可以最小化），请耐心等待更新完成；</div>'
            str += '<div>2.更新完成后的版本将为 Version '+localStorage.getItem("ccl-bill-new")+'，新的程序版本将在当前程序所在目录的上一级目录中存放，与当前使用的程序互不干扰</div>'
            str += '<div>3.使用新的程序前，需要将正在使用的旧程序全部退出；再前往新的程序目录下找到exe启动程序即可（旧程序可自行选择删除或继续保留）</div>'
            layer.confirm(str, {
                    btn: ['更新', '取消'],
                    title: "更新前请注意以下信息",
                    area: ['550px', ''],
                },
                function(index, layero){
                    show_loading("系统正在更新中，请不要退出......")
                    $.ajax({
                        url: "/system/update",
                        method: "POST",
                        dataType: "json",
                        success: function (data) {
                            // 请求成功时的处理
                            if (data.ret > 0) {
                                layer.msg("更新错误！"+data.msg, {
                                    time: 0,
                                    btn: ['好的'],
                                    area: ['600px', ''],
                                    btn2:function () {
                                        layer.close()
                                    }
                                });
                                return false
                            }
                            updated_status()
                            layer.msg("更新成功！使用新版本请先将当前程序全部退出（程序控制台和网页），新版本程序文件保存在程序所在目录的上一级目录中，文件名为新的版本号",
                                {
                                    time: 0,
                                    btn: ['好的'], //可以无限个按钮
                                    area: ['600px', ''],
                                    btn2:function () {
                                        layer.close()
                                    }
                                });
                        },
                        error: function (error) {
                            // 请求失败时的处理
                            layer.confirm("服务器异常", {icon: 3, title:'更新错误'}, function(index){
                                layer.close(index);
                            });
                        },
                        complete: function() {
                            // 请求完成后隐藏加载中动画
                            hide_loading()
                        }
                    });
                }
            );
        });
    });
</script>
</body>
</html>