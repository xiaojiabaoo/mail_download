<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <link rel="icon" href="http://127.0.0.1:8023/static/image/img.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>CLL</title>
    <link rel="stylesheet" href="/static/js/layui-v2.6.8/css/layui.css">
    <link rel="stylesheet" href="/static/css/config.css">
    <style>
        .child {
            display: inline-block;
            /*子元素文字会继承居中，因此要在上面写上向左边居中*/
            text-align: left;
            background-color: #FAFAFA;
            width: 1000px;
            height: 2200px;
            border-radius: 5px;
        }

        .parent {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .tips-night {
            color: #EAECEE;
            -webkit-background-clip: text;
            font-weight: bold;
        }

        .tips-day {
            color: #1B2631;
            -webkit-background-clip: text;
            font-weight: bold;
        }

        /* 模态框（背景） */
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定定位 */
            z-index: 1; /* 置于顶层 */
            padding-top: 70px; /* 距离顶部 */
            left: 0;
            top: 0;
            width: 100%; /* 宽度 */
            height: 100%; /* 高度 */
            overflow: auto; /* 超出部分滚动 */
            background-color: rgb(0,0,0); /* 背景色 */
            background-color: rgba(0,0,0,0.6); /* 背景色，半透明 */
        }

        /* 模态框内容（图片） */
        .modal-content {
            margin: auto;
            display: block;
            width: 85%;
            max-width: 100%;
            border-radius: 7px;
        }

        /* 关闭按钮 */
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* 添加一些额外的动画效果（可选） */
        @keyframes zoom {
            from {transform: scale(0)}
            to {transform: scale(1)}
        }

        .modal-content {
            animation-name: zoom;
            animation-duration: 0.6s;
        }
    </style>
</head>
<body>
<form class="layui-form" action="">
    <div class="parent">
        <div class="child">
            <div id="load_update_div" style="margin-left: 30px;margin-top: 30px;font-size: 17px;font-weight: bold;">
                <span style="">获取程序包更新地址</span>：
                <span style="color: #87CEEB;">https://gitee.com/xiaojiabaoo/mail_download/tree/main/</span>
                <span>（访问前请先开启代理）</span>
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                以下是更新包下载教程步骤（共六步），若不熟悉请按照教程进行操作
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                第一步：复制上方的<span style="color:#FFA500;">程序包更新地址</span>后前往新窗口请求
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                第二步：请求后请查看中间的程序包列表（如下图所示），可能会出现多个版本的程序包，请找到对应需要下载的版本并点击进入
            </div>
            <div class="layui-form-item" style="margin-top: 20px;margin-left: 30px;">
                <img class="tutorial-img" style="border-radius:7px;cursor: pointer;" src="/static/image/jiaocheng1.png" width="940px" height="440px">
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                第三步：进入后请查看页面上方，点击页面中的绿色“Code”按钮（如下图所示）
            </div>
            <div class="layui-form-item" style="margin-top: 20px;margin-left: 30px;">
                <img class="tutorial-img" style="border-radius:7px;cursor: pointer;" src="/static/image/jiaocheng1.png" width="940px" height="440px">
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                第四步：点击按钮后页面将会出现一个弹窗，点击弹窗中的“Download ZIP”按钮下载（如下图所示）
            </div>
            <div class="layui-form-item" style="margin-top: 20px;margin-left: 30px;">
                <img class="tutorial-img" style="border-radius:7px;cursor: pointer;" src="/static/image/jiaocheng1.png" width="940px" height="440px">
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                第五步：下载后将程序包存放在合适位置后解压（也可以下载前选好保存位置）<br>
                <span style="color: #DC143C;margin-left: 55px;">程序包内的任何文件不可移动或修改，否则将导致程序不可用！</span>
                若发生程序不可用的情况，请按照以上步骤重新下载程序即可
            </div>
            <div style="margin-left: 30px;margin-top: 20px;font-size: 14px;font-weight: bold;">
                第六步：打开文件夹，找到“先点我启动程序.exe”点击即可启动服务（如下图所示），启动前请先关闭运行中的旧程序，否则会因冲突导致程序启动失败
            </div>
            <div class="layui-form-item" style="margin-top: 20px;margin-left: 30px;">
                <img class="tutorial-img" style="border-radius:7px;cursor: pointer;" src="/static/image/jiaocheng1.png" width="940px" height="440px">
            </div>
        </div>
        <div style="font-size: 12px;color: #C0C0C0;margin-top: 10px;">
            <span>使用上遇到任何问题请联系技术人员，联系邮件地址：<a href="mailto:xiaoben.mail@foxmail.com">xiaoben.mail@foxmail.com</a></span>
        </div>
    </div>
</form>
<div id="enlarge" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="enlarge_img">
    <div id="caption"></div>
</div>
<script src="/static/js/layui-v2.6.8/layui.js"></script>
<script type="text/javascript" src="/static/js/jquery-2.1.3.js"></script>
<script src="/static/js/config.js" charset="utf-8"></script>
<script>
    layui.use(['layer', 'laydate'], function () {
        let form = layui.form;
        let layer = layui.layer;
        let date = new Date();
        if (date.getHours() >= 18 || date.getHours() <= 6) {
            $("body").css("background-color", "#111")
            $(".child").css("background-color", "#222").css("color", "#f2f2f2")
            $("input").css("background-color", "#333")
            $("input").css("border", "none")
            $("input").css("color", "#f2f2f2")
            $("#tips").removeClass("tips-day")
            $("#tips").addClass("tips-night")
            form.render();
        } else {
            $("#tips").removeClass("tips-night")
            $("#tips").addClass("tips-day")
        }

        // 获取模态框
        let enlarge = document.getElementById("enlarge");
        let enlargeImg = document.getElementById("enlarge_img");
        // 获取图片和模态框中的图片标签
        $(".tutorial-img").click(function(){
            enlarge.style.display = "block";
            enlargeImg.src = this.src; // 设置模态框中图片的源为点击的图片源
        });
        // 获取关闭按钮
        let span = document.getElementsByClassName("close")[0];
        // 点击关闭按钮时隐藏模态框
        span.onclick = function() {
            enlarge.style.display = "none";
        }
        // 点击模态框外部区域时也可以关闭（可选）
        window.onclick = function(event) {
            if (event.target == enlarge) {
                enlarge.style.display = "none";
            }
        }

        /*$("#danqian_banben").text("Version "+localStorage.getItem("ccl_danqian_banben"))
        window.hasUpdateHtml = function (version, describe) {
            let str = ''
            str += '<span>最新版本：Version '+version+'   <span class="layui-badge">新</span></span>'
            str += '<div style="margin-top: 10px;line-height: 25px;width: 870px;">更新描述：'+ describe+'</div>'
            $("#content").html(str)
            $(".child").height((180+90)+"px")
            $("#update_button").show()
            $("#load_update_div").hide()
            $("#has_update_div").show()
            form.render();
        }

        window.noUpdateHtml = function () {
            let str = ''
            str += '<span>已是最新版本，无需更新</span>'
            $("#content").html(str)
            $(".child").height("180px")
            $("#update_button").hide()
            $("#load_update_div").hide()
            $("#has_update_div").show()
            form.render();
        }

        window.updated_status = function () {
            localStorage.setItem("ccl_danqian_banben", localStorage.getItem("ccl_xin_banben"))
            localStorage.removeItem("ccl_xin")
            localStorage.removeItem("ccl_xin_banben")
            localStorage.removeItem("ccl_xin_miaoshu")
            window.parent.UpdateTab()
            noUpdateHtml()
            $("#danqian_banben").text("Version "+localStorage.getItem("ccl_danqian_banben"))
        }

        window.an_update = function (result) {
            localStorage.setItem("ccl_xin", "true");
            localStorage.setItem("ccl_xin_banben", result.new_version);
            localStorage.setItem("ccl_danqian_banben", result.current_version);
            localStorage.setItem("ccl_xin_miaoshu", result.describe);
            hasUpdateHtml(result.new_version, result.describe)
            $("#danqian_banben").text("Version "+result.current_version)
            window.parent.UpdateTab()
        }

        window.no_update = function (version) {
            $("#danqian_banben").text("Version "+version)
            localStorage.setItem("ccl_danqian_banben", version);
            localStorage.removeItem("ccl_xin")
            localStorage.removeItem("ccl_xin_banben")
            localStorage.removeItem("ccl_xin_miaoshu")
            noUpdateHtml()
            window.parent.UpdateTab()
        }

        window.getNowVersion = function () {
            $.ajax({
                url: "/system/check_update",
                method: "POST",
                data: '{"type":1}',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    // 请求成功时的处理
                    if (data.ret > 0) {
                        layer.msg(data.msg, {icon: 5, anim: 6});
                        return false
                    }
                    let result = data.data
                    localStorage.setItem("ccl_danqian_banben",result.current_version)
                },
                error: function (error) {
                    // 请求失败时的处理
                    layer.msg("服务器异常", {icon: 5, anim: 6});
                }
            });
            form.render();
        }

        window.getUpdateData = function (source) {
            if (source == "click") {
                show_loading("检查更新中，请不要关闭或刷新网站，请稍后......")
            }
            $.ajax({
                url: "/system/check_update",
                method: "POST",
                dataType: "json",
                success: function (data) {
                    // 请求成功时的处理
                    if (data.ret > 0) {
                        layer.msg(data.msg, {icon: 5, anim: 6});
                        return false
                    }
                    let result = data.data
                    if (result.new_version == 0) {
                        layer.msg("检查更新出现错误", {icon: 2, anim: 6})
                        return false
                    }
                    let date = new Date()
                    localStorage.setItem("check_update_time", date.getTime()/1000);
                    if (result.current_version == result.new_version) {
                        if (source == "click") {
                            layer.msg("当前已是最新版本，无需更新", {icon: 7, anim: 6})
                        }
                        no_update(result.current_version)
                        return false
                    } else {
                        if (source == "click") {
                            layer.msg("检测到新版本：Version "+result.new_version, {icon: 1, anim: 1})
                        }
                        an_update(result)
                    }
                    if (source == "init") {
                        $("#ccl_danqian_banben").text("Version "+result.current_version)
                    }
                },
                error: function (error) {
                    // 请求失败时的处理
                    layer.msg("服务器异常", {icon: 5, anim: 6});
                },
                complete: function() {
                    // 请求完成后隐藏加载中动画
                    if (source == "click") {
                        hide_loading()
                    }
                }
            });
        };

        $("#check_update_button").click(function() {
            getUpdateData("click")
        });

        $(".clear_cache").click(function() {
            localStorage.removeItem("ccl_xin")
            localStorage.removeItem("ccl_xin_banben")
            localStorage.removeItem("ccl_xin_miaoshu")
            localStorage.removeItem("ccl_danqian_banben")
            localStorage.removeItem("check_update_time")
            form.render();
            window.parent.location.reload()
        });

        $(".layui-btn-fluid").click(function() {
            let str = ''
            str += '<div>1.更新过程视网络情况可能需要较长的时间，正常情况下不会超过5分钟，更新过程中请不要退出程序和网页（可以最小化），请耐心等待更新完成；</div>'
            str += '<div>2.更新完成后的版本将为 Version '+localStorage.getItem("ccl_xin_banben")+'，新的程序版本将在当前程序所在目录的上一级目录中存放，与当前使用的程序互不干扰</div>'
            str += '<div>3.使用新的程序前，需要将正在使用的旧程序全部退出；再前往新的程序目录下找到exe启动程序即可（旧程序可自行选择删除或继续保留）</div>'
            layer.confirm(str, {
                    btn: ['更新', '取消'],
                    title: "更新前请注意以下信息",
                    area: ['550px', ''],
                },
                function(index, layero){
                    show_loading("系统正在更新中，请不要退出......")
                    $.ajax({
                        url: "/system/update",
                        method: "POST",
                        dataType: "json",
                        success: function (data) {
                            // 请求成功时的处理
                            if (data.ret > 0) {
                                layer.msg("更新错误！"+data.msg, {
                                    time: 0,
                                    btn: ['好的'],
                                    area: ['600px', ''],
                                    btn2:function () {
                                        layer.close()
                                    }
                                });
                                return false
                            }
                            updated_status()
                            layer.msg("更新成功！使用新版本请先将当前程序全部退出（程序控制台和网页），新版本程序文件保存在程序所在目录的上一级目录中，文件名为新的版本号",
                                {
                                    time: 0,
                                    btn: ['好的'], //可以无限个按钮
                                    area: ['600px', ''],
                                    btn2:function () {
                                        layer.close()
                                    }
                                });
                        },
                        error: function (error) {
                            // 请求失败时的处理
                            layer.confirm("服务器异常", {icon: 3, title:'更新错误'}, function(index){
                                layer.close(index);
                            });
                        },
                        complete: function() {
                            // 请求完成后隐藏加载中动画
                            hide_loading()
                        }
                    });
                }
            );
        });*/
    });
</script>
</body>
</html>